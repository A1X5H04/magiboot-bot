import { FormattedString } from "https://esm.sh/@grammyjs/parse-mode@2.2.0";

import { PostMetadata } from "../types/schema.ts";
import { TGUserInfo } from "../types/bot.ts";
import { LeaderboardEntry } from "../services/leaderboard.ts";
import { TG_CHANNEL_ID } from "./constants.ts";
import { RankedPost } from "../repositories/post.ts";

type KnownError = Error & {
    code?: string;
    status?: number;
};

export interface EnrichedRankedPost extends RankedPost {
    rank: number;
    creator: TGUserInfo;
}

export function createBootanimationPost({ title, creator, details, tags }: Omit<PostMetadata, "download_url" | "video">) {
    const tagString = tags.map(t => `#${t}`).join(' ');

    return new FormattedString(tagString).plain("\n\n")
    .b(`ðŸŽžï¸ ${title}`).plain("\n\n")
        .b("Details:\n")
        .plain("â€¢ Resolution: ").code(`${details.resolution.module} [${details.resolution.video}]`).plain("\n")
        .plain("â€¢ FPS: ").code(details.fps).plain("\n")
        .plain("â€¢ Duration: ").code(`${details.duration}s`).plain("\n")
        .plain("â€¢ Type: ").code(details.type)
        .plain("\n\n")
        .b("âš™ï¸ How to Use").plain("\n")
        .plain("Flash the module via your favorite root solution: Magisk / KernelSU")
        .plain("\n\n")
        .b("âœ¨ Credits").plain("\n")
        .plain("â€¢ Animation By: ").link(creator.name, `tg://user?id=${creator.user_id}`).plain("\n")
        .plain("â€¢ Generated By: @magibootbot")
        .plain("\n\n")
        .plain("ðŸ‘¥ Join: @magibootcommunity and @magiboot" ).plain("\n")
        .plain("ðŸ“¢ Follow for more animations & updates").plain("\n")
        .plain("ðŸ› ï¸ Issues? ").link("Report Here", "https://t.me/magibootchat")
}

export function createErrorMessage(
    err: KnownError,
    contextAction = "processing your request",
): FormattedString {
    // Extract safe error details
    const errType = err.name ?? "UnknownError";
    const errMsg = err.message ?? "No details provided.";
    const errCode = err.code ?? "N/A";

    // If you want to hide raw error messages from users, you can toggle this
    const showDetails = true; // change to false for production

    const message = FormattedString.b("âš ï¸ Oops! Something went wrong.").plain("\n\n")
        .plain(`There was an error while ${contextAction}.\n`)
        .plain("Please contact @a1x5h04 if the issue persists.");

    if (showDetails) {
        message.plain("\n\n")
            .b("Error Details:\n")
            .plain(`â€¢ Type: `).code(errType).plain("\n")
            .plain(`â€¢ Message: `).code(errMsg).plain("\n")
            .plain(`â€¢ Code: `).code(errCode);
    }

    return message;
}

export function createDuplicatePostErrorMessage({ name, message_id, user }: {
    name: string;
    message_id: number;
    user: TGUserInfo;
}) {
    return FormattedString
        .b("ðŸ” Duplicate Post Detected!")
        .plain("\n\n")
        .i("This post already exists in the community.")
        .plain("\n\n")
        .b("ðŸ“„ Post: ").plain(name).plain("\n")
        .b("ðŸ”— Original: ").link("View on Channel", `https://t.me/magibootcommunity/${message_id}`).plain("\n")
        .b("ðŸ‘¤ Author: ").link(user.first_name, `tg://user?id=${user.id}`)
        .plain("\n\n")
        .i("Please modify your post before uploading again.");
}

export function createValidationErrorMessage(errors: string[]) {
    const errorCount = errors.length;
    if (errorCount === 0) {
        return FormattedString.b("Validation Failed! ðŸ˜µâ€ðŸ’«").plain("\n\nAn unknown error occurred.");
    }

    let message = FormattedString.b("Validation Failed! ðŸ˜µâ€ðŸ’«").plain("\n\n")
        .plain("Please fix the following " + (errorCount > 1 ? "errors" : "error") + " and try again:");
    errors.forEach(error => {
        message = message.plain("\nâ€¢ ").plain(error);
    });

    return message;
}


export function createLeaderBoardMessage(entries: LeaderboardEntry[]) {
    console.log("Leaderboard", entries);
    let message = new FormattedString("").b(`ðŸ† Top 10 Creators`).plain("\n\n");

    if (entries.length === 0) {
        message = message.plain("No votes yet, go react your favourite bootanimations.");
        return message;
    }

    const medals = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"];


    for (const entry of entries) {
        const rankIcon = medals[entry.rank - 1] || ` ${entry.rank.toString()}. `

        message = message
            .plain(rankIcon).plain(" ")
            .b(entry.score.toString()).plain(" pts").plain(" â€” ")
            .link(entry.user.first_name, `tg://user?id=${entry.user.id}`)
            .plain("\n")
            .plain("     â€¢  ")
            .plain(entry.total_votes.toString()).plain(" votes, ")
            .plain(entry.total_downloads.toString()).plain(" downloads\n");
    }

    return message;
}

export function createRankedPostsMessage(
    posts: EnrichedRankedPost[],
    title: string
): FormattedString {
    let message = new FormattedString("").b(title).plain("\n\n");

    if (posts.length === 0) {
        message = message.plain("No posts found for this category. Be the first!");
        return message;
    }

    const medals = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"];

    for (const post of posts) {
        const rankIcon = medals[post.rank - 1] || ` ${post.rank.toString()}. `;
        
        let tags: string[] = [];
        if (post.tags) {
            try {
                tags = JSON.parse(post.tags);
            } catch (e) { /* ignore invalid json */ }
        }
        const tagString = tags.map(t => `#${t}`).join(' ');

        message = message
            .plain(rankIcon)
            .link(post.name, `https://t.me/c/${TG_CHANNEL_ID.replace("-100", "")}/${post.message_id}`)
            .plain("\n")            
            .plain("     â€¢  ")
            .b(post.download_count.toString()).plain(" downloads")
            .plain(" | ")
            .b(post.votes.toString()).plain(" votes")
            .plain("\n")
            .plain("     â€¢  By: ")
            .link(post.creator.first_name, `tg://user?id=${post.creator.id}`)
            .plain("\n");
        
        if (tagString) {
            message = message.plain("     â€¢  Tags: ").i(tagString).plain("\n");
        }
    }

    return message;
}